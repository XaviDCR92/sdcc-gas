                                      1 ;--------------------------------------------------------------------------
                                      2 ;  setjmp.s
                                      3 ;
                                      4 ;  Copyright (C) 2014, Philipp Klaus Krause
                                      5 ;
                                      6 ;  This library is free software; you can redistribute it and/or modify it
                                      7 ;  under the terms of the GNU General Public License as published by the
                                      8 ;  Free Software Foundation; either version 2, or (at your option) any
                                      9 ;  later version.
                                     10 ;
                                     11 ;  This library is distributed in the hope that it will be useful,
                                     12 ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
                                     13 ;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
                                     14 ;  GNU General Public License for more details.
                                     15 ;
                                     16 ;  You should have received a copy of the GNU General Public License 
                                     17 ;  along with this library; see the file COPYING. If not, write to the
                                     18 ;  Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston,
                                     19 ;   MA 02110-1301, USA.
                                     20 ;
                                     21 ;  As a special exception, if you link this library with other files,
                                     22 ;  some of which are compiled with SDCC, to produce an executable,
                                     23 ;  this library does not by itself cause the resulting executable to
                                     24 ;  be covered by the GNU General Public License. This exception does
                                     25 ;  not however invalidate any other reasons why the executable file
                                     26 ;   might be covered by the GNU General Public License.
                                     27 ;--------------------------------------------------------------------------
                                     28 
                                     29 	.area   CODE
                                     30 
                                     31 	.globl ___setjmp
                                     32 
      000000                         33 ___setjmp:
      000000 16 04            [ 2]   34 	ldw	y, (4, sp)
                                     35 
                                     36 	; store return address
      000002 1E 01            [ 2]   37 	ldw	x, (1, sp)
      000004 90 FF            [ 2]   38 	ldw	(y), x
      000006 7B 03            [ 1]   39 	ld	a, (3, sp)
      000008 90 E7 02         [ 1]   40 	ld	(2, y), a
                                     41 
                                     42 	; store stack pointer
      00000B 96               [ 1]   43 	ldw	x, sp
      00000C 90 EF 03         [ 2]   44 	ldw	(3, y), x
                                     45 
                                     46 	; return 0
      00000F 5F               [ 1]   47 	clrw	x
                                     48 
      000010 87               [ 5]   49 	retf
                                     50 
                                     51 	.globl _longjmp
                                     52 
      000011                         53 _longjmp:
      000011 1E 04            [ 2]   54 	ldw	x, (4, sp)
      000013 16 06            [ 2]   55 	ldw	y, (6, sp)
                                     56 
                                     57 	; Restore stack pointer
      000015 89               [ 2]   58 	pushw	x
      000016 EE 03            [ 2]   59 	ldw	x, (3, x)
      000018 EF 01            [ 2]   60 	ldw	(1, x), y
      00001A 90 85            [ 2]   61 	popw	y
      00001C 94               [ 1]   62 	ldw	sp, x
                                     63 
                                     64 	; Calculate return value
      00001D 85               [ 2]   65 	popw	x
      00001E 84               [ 1]   66 	pop	a
      00001F 5D               [ 2]   67 	tnzw	x
      000020 26 01            [ 1]   68 	jrne	jump
      000022 5C               [ 1]   69 	incw	x
      000023                         70 jump:
                                     71 	; return
      000023 90 F6            [ 1]   72 	ld	a, (y)
      000025 90 EE 01         [ 2]   73 	ldw	y, (1, y)
      000028 90 89            [ 2]   74 	pushw	y
      00002A 88               [ 1]   75 	push	a
      00002B 87               [ 5]   76 	retf
                                     77 
