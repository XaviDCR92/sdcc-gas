                                      1 ;--------------------------------------------------------------------------
                                      2 ;  __mulsint2slong.s
                                      3 ;
                                      4 ;  Copyright (C) 2016, Philipp Klaus Krause
                                      5 ;
                                      6 ;  This library is free software; you can redistribute it and/or modify it
                                      7 ;  under the terms of the GNU General Public License as published by the
                                      8 ;  Free Software Foundation; either version 2, or (at your option) any
                                      9 ;  later version.
                                     10 ;
                                     11 ;  This library is distributed in the hope that it will be useful,
                                     12 ;  but WITHOUT ANY WARRANTY; without even the implied warranty of
                                     13 ;  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
                                     14 ;  GNU General Public License for more details.
                                     15 ;
                                     16 ;  You should have received a copy of the GNU General Public License 
                                     17 ;  along with this library; see the file COPYING. If not, write to the
                                     18 ;  Free Software Foundation, 51 Franklin Street, Fifth Floor, Boston,
                                     19 ;   MA 02110-1301, USA.
                                     20 ;
                                     21 ;  As a special exception, if you link this library with other files,
                                     22 ;  some of which are compiled with SDCC, to produce an executable,
                                     23 ;  this library does not by itself cause the resulting executable to
                                     24 ;  be covered by the GNU General Public License. This exception does
                                     25 ;  not however invalidate any other reasons why the executable file
                                     26 ;   might be covered by the GNU General Public License.
                                     27 ;--------------------------------------------------------------------------
                                     28 
                                     29 .globl ___mulsint2slong
                                     30 .globl ___muluint2ulong
                                     31 
                                     32 .area CODE
                                     33 
      000000                         34 ___muluint2ulong:
      000000 4F               [ 1]   35 	clr a
      000001 1E 06            [ 2]   36 	ldw x, (6, sp)
      000003 20 11            [ 2]   37 	jra right_nonneg
                                     38 
      000005                         39 ___mulsint2slong:
                                     40 	
                                     41 	; Handle signed operands
      000005 4F               [ 1]   42 	clr	a
      000006 1E 04            [ 2]   43 	ldw	x, (4, sp)
      000008 2A 04            [ 1]   44 	jrpl	left_nonneg
      00000A 43               [ 1]   45 	cpl	a
      00000B 50               [ 2]   46 	negw	x
      00000C 1F 04            [ 2]   47 	ldw	(4, sp), x
      00000E                         48 left_nonneg:
      00000E 1E 06            [ 2]   49 	ldw	x, (6, sp)
      000010 2A 04            [ 1]   50 	jrpl	right_nonneg
      000012 43               [ 1]   51 	cpl	a
      000013 50               [ 2]   52 	negw	x
      000014 1F 06            [ 2]   53 	ldw	(6, sp), x
      000016                         54 right_nonneg:
                                     55 
      000016 52 04            [ 2]   56 	sub	sp, #4
      000018 88               [ 1]   57 	push	a
                                     58 
                                     59 	; Multiply lower bytes
      000019 7B 0A            [ 1]   60 	ld	a, (5+5, sp)
      00001B 42               [ 4]   61 	mul	x, a
      00001C 1F 04            [ 2]   62 	ldw	(4, sp), x
                                     63 
                                     64 	; Multiply upper bytes
      00001E 1E 08            [ 2]   65 	ldw	x, (5+3, sp)
      000020 7B 0B            [ 1]   66 	ld	a, (5+6, sp)
      000022 42               [ 4]   67 	mul	x, a
      000023 1F 02            [ 2]   68 	ldw	(2, sp), x
                                     69 
                                     70 	; Multiply middle bytes
      000025 7B 0B            [ 1]   71 	ld	a, (5+6, sp)
      000027 27 0E            [ 1]   72 	jreq	skip_m1
      000029 1E 09            [ 2]   73 	ldw	x, (5+4, sp)
      00002B 42               [ 4]   74 	mul	x, a
      00002C 72 FB 03         [ 2]   75 	addw	x, (3, sp)
      00002F 1F 03            [ 2]   76 	ldw	(3, sp), x
      000031 7B 02            [ 1]   77 	ld	a, (2, sp)
      000033 A9 00            [ 1]   78 	adc	a, #0
      000035 6B 02            [ 1]   79 	ld	(2, sp), a
      000037                         80 skip_m1:
                                     81 
      000037 7B 09            [ 1]   82 	ld	a, (5+4, sp)
      000039 27 0E            [ 1]   83 	jreq	skip_m2
      00003B 1E 0B            [ 2]   84 	ldw	x, (5+6, sp)
      00003D 42               [ 4]   85 	mul	x, a
      00003E 72 FB 03         [ 2]   86 	addw	x, (3, sp)
      000041 1F 03            [ 2]   87 	ldw	(3, sp), x
      000043 7B 02            [ 1]   88 	ld	a, (2, sp)
      000045 A9 00            [ 1]   89 	adc	a, #0
      000047 6B 02            [ 1]   90 	ld	(2, sp), a
      000049                         91 skip_m2:
                                     92 
                                     93 	; Handle signed result
      000049 84               [ 1]   94 	pop	a
      00004A 90 85            [ 2]   95 	popw	y
      00004C 85               [ 2]   96 	popw	x
      00004D 4D               [ 1]   97 	tnz	a
      00004E 2A 07            [ 1]   98 jrpl	end
      000050 50               [ 2]   99 	negw	x
      000051 24 02            [ 1]  100 jrnc	neg_y
      000053 90 5C            [ 1]  101 	incw	y
      000055                        102 neg_y:
      000055 90 50            [ 2]  103 	negw	y
      000057                        104 end:
      000057 87               [ 5]  105 	retf
                                    106 
